select * from(SELECT row_number() over(ORDER BY COURSENOGROUP) as row,
SCHEDULE.COURSENO+SCHEDULE.[GROUP] AS kh,
COURSES.COURSENAME as km,
COURSETYPEOPTIONS.VALUE AS kclb,
SCHEDULE.ROOMNO as jsh,
CLASSROOMS.JSN jsjc,ISNULL(SELECTION.ATTENDENTS,0) AS xxrs,CLASSROOMS.SEATS as zws
FROM SCHEDULE LEFT OUTER JOIN
(
	SELECT R32.YEAR,R32.TERM,R32.COURSENO+R32.[GROUP] AS COURSENOGROUP,
	COUNT(*) AS ATTENDENTS FROM R32
	GROUP BY R32.YEAR,R32.TERM,R32.COURSENO,R32.[GROUP]
)AS SELECTION ON SCHEDULE.YEAR=SELECTION.YEAR AND SCHEDULE.TERM=SELECTION.TERM
AND SCHEDULE.COURSENO+SCHEDULE.[GROUP]=SELECTION.COURSENOGROUP
JOIN CLASSROOMS ON SCHEDULE.ROOMNO=CLASSROOMS.ROOMNO
AND CLASSROOMS.SEATS>CAST(:MARGIN AS int)+ISNULL(SELECTION.ATTENDENTS,0)
JOIN COURSES ON SCHEDULE.COURSENO=COURSES.COURSENO
JOIN COURSETYPEOPTIONS ON COURSES.TYPE=COURSETYPEOPTIONS.NAME
JOIN COURSEPLAN ON SCHEDULE.COURSENO=COURSEPLAN.COURSENO AND SCHEDULE.[GROUP]=COURSEPLAN.[GROUP]
AND SCHEDULE.YEAR=COURSEPLAN.YEAR AND SCHEDULE.TERM=COURSEPLAN.TERM
AND COURSEPLAN.CLASSNO NOT LIKE :CLASSNOFILTER
WHERE SCHEDULE.YEAR=:YEAR
AND SCHEDULE.TERM=:TERM
) as b where b.row between :start and :end




