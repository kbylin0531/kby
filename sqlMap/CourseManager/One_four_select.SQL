select * from(SELECT row_number() over(order by COURSEPLAN.COURSENO+COURSEPLAN.[GROUP]) as row,
COURSEPLAN.COURSENO+COURSEPLAN.[GROUP] AS kh,
COURSES.COURSENAME as km,
SCHOOLS.NAME as kkxy,
COURSES.SCHOOL,
COURSETYPEOPTIONS.VALUE AS kclb,
COURSEPLAN.CLASSNO as bh,
CLASSES.CLASSNAME as bm,
ISNULL(SELECTION.ATTENDENTS,0) AS xkrs
FROM COURSEPLAN JOIN CLASSES ON COURSEPLAN.CLASSNO=CLASSES.CLASSNO
JOIN COURSES ON COURSEPLAN.COURSENO=COURSES.COURSENO
INNER JOIN SCHOOLS ON SCHOOLS.SCHOOL=COURSEs.SCHOOL
JOIN COURSETYPEOPTIONS ON COURSES.TYPE=COURSETYPEOPTIONS.NAME
LEFT OUTER JOIN
(
	SELECT R32.YEAR,R32.TERM,R32.COURSENO+R32.[GROUP] AS COURSENOGROUP,
	COUNT(*) AS ATTENDENTS FROM R32
	WHERE R32.YEAR=:YONE AND R32.TERM=:TONE
	GROUP BY R32.YEAR,R32.TERM,R32.COURSENO,R32.[GROUP]
) AS SELECTION
ON COURSEPLAN.YEAR=SELECTION.YEAR AND COURSEPLAN.TERM=SELECTION.TERM
AND COURSEPLAN.COURSENO+COURSEPLAN.[GROUP]=SELECTION.COURSENOGROUP
WHERE (SELECTION.ATTENDENTS<:MARGIN OR SELECTION.ATTENDENTS IS NULL)
AND COURSEPLAN.YEAR=:YTWO
AND COURSEPLAN.TERM=:TTWO
AND COURSEPLAN.CLASSNO NOT LIKE :CLASSNOFILTER
) as b where b.row between :start and :end



