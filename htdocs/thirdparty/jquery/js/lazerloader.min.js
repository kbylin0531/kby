/**
 * Created by Lin on 2015/5/22.
 * Email:784855684@qq.com
 * Version: 1.0
 */
function Lazerloader(){var pro=Lazerloader.prototype;var env=this;env.url="source.php";env.total=0;env.predata=null;env.cur=0;env.size=10;env.ctnselector="body";env.tplid="";env.delay=0;env.tag="";env.precall=null;env.loadcall=null;env.isfirst=true;env.curtpl=null;env.curclone=null;window.console=window.console||(function(){var c={};c.log=c.warn=c.debug=c.info=c.error=c.time=c.dir=c.profile=c.clear=c.exception=c.trace=c.assert=function(){};return c})();pro.init=function(obj){env.tag="gettotal";env.total=0;env.cur=0;env.isfirst=true;for(var x in obj){if(x in env){env[x]=obj[x]}}var tpl=$("#"+env.tplid);tpl.length&&tpl.css("display","none")};pro.doAjax=function(url,senddata,isasync,callback,param){var dat=null;senddata.curindex=env.cur;senddata.size=env.size;senddata.total=env.total;$.ajax({type:"POST",url:env.url,data:senddata,async:isasync===null?true:isasync,success:function(data){if(callback!==null){callback(data,param)}dat=eval("("+data+")")}});return dat};pro.getClone=function(tplselect,container,tag){var clone=container.find(tplselect).eq(0).clone().css("display","").css("height","auto").removeAttr("id");if(tag!==true){clone.html("")}return clone};pro.nestThrough=function(key,val,container){if(val instanceof Object){for(var x in val){if(isNaN(x)){if(val[x] instanceof Object){}else{var newcontainer=env.getClone("."+key,env.curtpl,true);for(var i in val){newcontainer.find("."+i).html(val[i])}container.append(newcontainer);break}}else{var newcontainer=env.getClone("."+key,env.curtpl,true);if(val[x] instanceof Object){for(var i in val[x]){newcontainer.find("."+i).html(val[x][i])}}else{}container.append(newcontainer)}}}else{var newcontainer=env.getClone("."+key,env.curtpl).html(val);container.append(newcontainer)}};pro.loadTemplate=function(tplid,data){for(var i=0;i<data.length;i++){env.curtpl=$("#"+env.tplid,$(env.ctnselector));env.curclone=env.getClone("#"+env.tplid,$(env.ctnselector));for(var x in data[i]){env.nestThrough(x,data[i][x],env.curclone)}$(env.ctnselector).append(env.curclone)}};pro.loadData=function(data){env.loadTemplate(env.tplid,data.data);if(env.loadcall){env.loadcall(data)}};pro.autoLoad=function(){if(env.isfirst&&env.predata.length>0){env.loadData(env.doAjax(env.url,{"tag":env.tag,"keydata":env.predata.slice(env.cur,env.cur+env.size)},false,null,null));env.cur+=env.size;env.isfirst=false}setTimeout(function(){if(env.cur<env.total){env.loadData(env.doAjax(env.url,{"tag":env.tag,"keydata":env.predata.slice(env.cur,env.cur+env.size)},false,null,null));env.cur+=env.size;return env.autoLoad()}},env.delay)};pro.followLoad=function(){};pro.preload=function(){var res=env.doAjax(env.url,{"tag":env.tag},false,null,null);if(res){env.predata=res.data;env.total=res.total||env.predata.length}else{return false}env.tag="getdata";if(env.precall){env.precall(res)}return true};pro.start=function(obj){env.init(obj);if(!env.preload()){alert("无法从网络连接中获取数据，请检查网络或服务器是否正常运行!")}else{}env.autoLoad();return env}};